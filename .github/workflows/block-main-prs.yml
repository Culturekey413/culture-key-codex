name: block-main-prs
on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled]
jobs:
  guard:
    if: github.base_ref == 'main'
    permissions:
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const requiredLabel = 'approved-for-main';
            const {owner, repo, number} = context.issue;
            const pr = (await github.rest.pulls.get({owner, repo, pull_number: number})).data;
            const hasLabel = pr.labels.some(l => l.name === requiredLabel);
            if (!hasLabel) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `🚫 Αυτό το PR στο \`main\` κλείστηκε γιατί δεν έχει την ετικέτα **${requiredLabel}**. \
Πρόσθεσε την ετικέτα όταν εγκριθεί ρητά και ξανάνοιξέ το.`
              });
              await github.rest.pulls.update({owner, repo, pull_number: number, state: 'closed'});
              throw new Error('Closed PR targeting main without required label.');
            }
