name: block-main-prs
on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled]
jobs:
  guard:
    if: github.base_ref == 'main'
    permissions:
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const requiredLabel = 'approved-for-main';
            const {owner, repo, number} = context.issue;
            const pr = (await github.rest.pulls.get({owner, repo, pull_number: number})).data;
            const hasLabel = pr.labels.some(l => l.name === requiredLabel);
            if (!hasLabel) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `ğŸš« Î‘Ï…Ï„ÏŒ Ï„Î¿ PR ÏƒÏ„Î¿ \`main\` ÎºÎ»ÎµÎ¯ÏƒÏ„Î·ÎºÎµ Î³Î¹Î±Ï„Î¯ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Ï„Î·Î½ ÎµÏ„Î¹ÎºÎ­Ï„Î± **${requiredLabel}**. \
Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î·Î½ ÎµÏ„Î¹ÎºÎ­Ï„Î± ÏŒÏ„Î±Î½ ÎµÎ³ÎºÏÎ¹Î¸ÎµÎ¯ ÏÎ·Ï„Î¬ ÎºÎ±Î¹ Î¾Î±Î½Î¬Î½Î¿Î¹Î¾Î­ Ï„Î¿.`
              });
              await github.rest.pulls.update({owner, repo, pull_number: number, state: 'closed'});
              throw new Error('Closed PR targeting main without required label.');
            }
